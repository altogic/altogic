import H,{Fragment as pe,createContext as J,createRef as ue,useCallback as Q,useContext as Y,useMemo as E,useReducer as se,useRef as A}from"react";import{useComputed as W}from"../../hooks/use-computed.js";import{useDisposables as Z}from"../../hooks/use-disposables.js";import{useEvent as O}from"../../hooks/use-event.js";import{useId as B}from"../../hooks/use-id.js";import{useIsoMorphicEffect as I}from"../../hooks/use-iso-morphic-effect.js";import{useLatestValue as be}from"../../hooks/use-latest-value.js";import{useOutsideClick as de}from"../../hooks/use-outside-click.js";import{useResolveButtonType as ce}from"../../hooks/use-resolve-button-type.js";import{useSyncRefs as V}from"../../hooks/use-sync-refs.js";import{useTreeWalker as fe}from"../../hooks/use-tree-walker.js";import{calculateActiveIndex as me,Focus as y}from"../../utils/calculate-active-index.js";import{disposables as ee}from"../../utils/disposables.js";import{forwardRefWithAs as _,render as F,compact as xe,Features as te}from"../../utils/render.js";import{isDisabledReactIssue7711 as Te}from"../../utils/bugs.js";import{match as w}from"../../utils/match.js";import{objectToFormEntries as Oe}from"../../utils/form.js";import{sortByDomNode as Re}from"../../utils/focus-management.js";import{Hidden as Ce,Features as ge}from"../../internal/hidden.js";import{useOpenClosed as ve,State as $,OpenClosedProvider as ye}from"../../internal/open-closed.js";import{Keys as S}from"../keyboard.js";var Se=(o=>(o[o.Open=0]="Open",o[o.Closed=1]="Closed",o))(Se||{}),Pe=(o=>(o[o.Single=0]="Single",o[o.Multi=1]="Multi",o))(Pe||{}),Ae=(o=>(o[o.Pointer=0]="Pointer",o[o.Other=1]="Other",o))(Ae||{}),Ie=(t=>(t[t.OpenCombobox=0]="OpenCombobox",t[t.CloseCombobox=1]="CloseCombobox",t[t.GoToOption=2]="GoToOption",t[t.RegisterOption=3]="RegisterOption",t[t.UnregisterOption=4]="UnregisterOption",t))(Ie||{});function q(n,a=o=>o){let o=n.activeOptionIndex!==null?n.options[n.activeOptionIndex]:null,e=Re(a(n.options.slice()),t=>t.dataRef.current.domRef.current),i=o?e.indexOf(o):null;return i===-1&&(i=null),{options:e,activeOptionIndex:i}}let De={[1](n){return n.dataRef.current.disabled||n.comboboxState===1?n:{...n,activeOptionIndex:null,comboboxState:1}},[0](n){if(n.dataRef.current.disabled||n.comboboxState===0)return n;let a=n.activeOptionIndex,{isSelected:o}=n.dataRef.current,e=n.options.findIndex(i=>o(i.dataRef.current.value));return e!==-1&&(a=e),{...n,comboboxState:0,activeOptionIndex:a}},[2](n,a){var i;if(n.dataRef.current.disabled||n.dataRef.current.optionsRef.current&&!n.dataRef.current.optionsPropsRef.current.static&&n.comboboxState===1)return n;let o=q(n);if(o.activeOptionIndex===null){let t=o.options.findIndex(p=>!p.dataRef.current.disabled);t!==-1&&(o.activeOptionIndex=t)}let e=me(a,{resolveItems:()=>o.options,resolveActiveIndex:()=>o.activeOptionIndex,resolveId:t=>t.id,resolveDisabled:t=>t.dataRef.current.disabled});return{...n,...o,activeOptionIndex:e,activationTrigger:(i=a.trigger)!=null?i:1}},[3]:(n,a)=>{let o={id:a.id,dataRef:a.dataRef},e=q(n,t=>[...t,o]);n.activeOptionIndex===null&&n.dataRef.current.isSelected(a.dataRef.current.value)&&(e.activeOptionIndex=e.options.indexOf(o));let i={...n,...e,activationTrigger:1};return n.dataRef.current.__demoMode&&n.dataRef.current.value===void 0&&(i.activeOptionIndex=0),i},[4]:(n,a)=>{let o=q(n,e=>{let i=e.findIndex(t=>t.id===a.id);return i!==-1&&e.splice(i,1),e});return{...n,...o,activationTrigger:1}}},X=J(null);X.displayName="ComboboxActionsContext";function N(n){let a=Y(X);if(a===null){let o=new Error(`<${n} /> is missing a parent <Combobox /> component.`);throw Error.captureStackTrace&&Error.captureStackTrace(o,N),o}return a}let z=J(null);z.displayName="ComboboxDataContext";function k(n){let a=Y(z);if(a===null){let o=new Error(`<${n} /> is missing a parent <Combobox /> component.`);throw Error.captureStackTrace&&Error.captureStackTrace(o,k),o}return a}function Ee(n,a){return w(a.type,De,n,a)}let he=pe,Le=_(function(a,o){let{name:e,value:i,onChange:t,disabled:p=!1,__demoMode:d=!1,nullable:r=!1,multiple:u=!1,...C}=a,[f,R]=se(Ee,{dataRef:ue(),comboboxState:d?0:1,options:[],activeOptionIndex:null,activationTrigger:1}),g=A(!1),x=A({static:!1,hold:!1}),c=A({displayValue:void 0}),m=A(null),U=A(null),M=A(null),h=A(null),D=O((s,b)=>s===b),T=Q(s=>w(l.mode,{[1]:()=>i.some(b=>D(b,s)),[0]:()=>D(i,s)}),[i]),l=E(()=>({...f,optionsPropsRef:x,inputPropsRef:c,labelRef:m,inputRef:U,buttonRef:M,optionsRef:h,value:i,disabled:p,mode:u?1:0,get activeOptionIndex(){if(g.current&&f.activeOptionIndex===null&&f.options.length>0){let s=f.options.findIndex(b=>!b.dataRef.current.disabled);if(s!==-1)return s}return f.activeOptionIndex},compare:D,isSelected:T,nullable:r,__demoMode:d}),[i,p,u,r,d,f]);I(()=>{f.dataRef.current=l},[l]),de([l.buttonRef,l.inputRef,l.optionsRef],()=>R({type:1}),l.comboboxState===0);let j=E(()=>({open:l.comboboxState===0,disabled:p,activeIndex:l.activeOptionIndex,activeOption:l.activeOptionIndex===null?null:l.options[l.activeOptionIndex].dataRef.current.value}),[l,p]),v=Q(()=>{var b;if(!l.inputRef.current)return;let s=c.current.displayValue;typeof s=="function"?l.inputRef.current.value=(b=s(i))!=null?b:"":typeof i=="string"?l.inputRef.current.value=i:l.inputRef.current.value=""},[i,l.inputRef,c]),P=O(s=>{let b=l.options.find(L=>L.id===s);!b||(K(b.dataRef.current.value),v())}),G=O(()=>{if(l.activeOptionIndex!==null){let{dataRef:s,id:b}=l.options[l.activeOptionIndex];K(s.current.value),v(),R({type:2,focus:y.Specific,id:b})}}),oe=O(()=>{R({type:0}),g.current=!0}),ne=O(()=>{R({type:1}),g.current=!1}),re=O((s,b,L)=>(g.current=!1,s===y.Specific?R({type:2,focus:y.Specific,id:b,trigger:L}):R({type:2,focus:s,trigger:L}))),ie=O((s,b)=>(R({type:3,id:s,dataRef:b}),()=>R({type:4,id:s}))),K=O(s=>w(l.mode,{[0](){return t(s)},[1](){let b=l.value.slice(),L=b.indexOf(s);return L===-1?b.push(s):b.splice(L,1),t(b)}})),ae=E(()=>({onChange:K,registerOption:ie,goToOption:re,closeCombobox:ne,openCombobox:oe,selectActiveOption:G,selectOption:P}),[]);I(()=>{l.comboboxState===1&&v()},[v,l.comboboxState]),I(v,[v]);let le=o===null?{}:{ref:o};return H.createElement(X.Provider,{value:ae},H.createElement(z.Provider,{value:l},H.createElement(ye,{value:w(l.comboboxState,{[0]:$.Open,[1]:$.Closed})},e!=null&&i!=null&&Oe({[e]:i}).map(([s,b])=>H.createElement(Ce,{features:ge.Hidden,...xe({key:s,as:"input",type:"hidden",hidden:!0,readOnly:!0,name:s,value:b})})),F({ourProps:le,theirProps:C,slot:j,defaultTag:he,name:"Combobox"}))))}),Me="input",_e=_(function(a,o){var h,D;let{value:e,onChange:i,displayValue:t,type:p="text",...d}=a,r=k("Combobox.Input"),u=N("Combobox.Input"),C=V(r.inputRef,o),f=r.inputPropsRef,R=`headlessui-combobox-input-${B()}`,g=Z();I(()=>{f.current.displayValue=t},[t,f]);let x=O(T=>{switch(T.key){case S.Backspace:case S.Delete:if(r.comboboxState!==0||r.mode!==0||!r.nullable)return;let l=T.currentTarget;g.requestAnimationFrame(()=>{l.value===""&&(u.onChange(null),r.optionsRef.current&&(r.optionsRef.current.scrollTop=0),u.goToOption(y.Nothing))});break;case S.Enter:if(r.comboboxState!==0)return;if(T.preventDefault(),T.stopPropagation(),r.activeOptionIndex===null){u.closeCombobox();return}u.selectActiveOption(),r.mode===0&&u.closeCombobox();break;case S.ArrowDown:return T.preventDefault(),T.stopPropagation(),w(r.comboboxState,{[0]:()=>{u.goToOption(y.Next)},[1]:()=>{u.openCombobox()}});case S.ArrowUp:return T.preventDefault(),T.stopPropagation(),w(r.comboboxState,{[0]:()=>{u.goToOption(y.Previous)},[1]:()=>{u.openCombobox(),g.nextFrame(()=>{r.value||u.goToOption(y.Last)})}});case S.Home:case S.PageUp:return T.preventDefault(),T.stopPropagation(),u.goToOption(y.First);case S.End:case S.PageDown:return T.preventDefault(),T.stopPropagation(),u.goToOption(y.Last);case S.Escape:return r.comboboxState!==0?void 0:(T.preventDefault(),r.optionsRef.current&&!r.optionsPropsRef.current.static&&T.stopPropagation(),u.closeCombobox());case S.Tab:if(r.comboboxState!==0)return;u.selectActiveOption(),u.closeCombobox();break}}),c=O(T=>{u.openCombobox(),i==null||i(T)}),m=W(()=>{if(!!r.labelRef.current)return[r.labelRef.current.id].join(" ")},[r.labelRef.current]),U=E(()=>({open:r.comboboxState===0,disabled:r.disabled}),[r]),M={ref:C,id:R,role:"combobox",type:p,"aria-controls":(h=r.optionsRef.current)==null?void 0:h.id,"aria-expanded":r.disabled?void 0:r.comboboxState===0,"aria-activedescendant":r.activeOptionIndex===null||(D=r.options[r.activeOptionIndex])==null?void 0:D.id,"aria-multiselectable":r.mode===1?!0:void 0,"aria-labelledby":m,disabled:r.disabled,onKeyDown:x,onChange:c};return F({ourProps:M,theirProps:d,slot:U,defaultTag:Me,name:"Combobox.Input"})}),Fe="button",we=_(function(a,o){var x;let e=k("Combobox.Button"),i=N("Combobox.Button"),t=V(e.buttonRef,o),p=`headlessui-combobox-button-${B()}`,d=Z(),r=O(c=>{switch(c.key){case S.ArrowDown:return c.preventDefault(),c.stopPropagation(),e.comboboxState===1&&i.openCombobox(),d.nextFrame(()=>{var m;return(m=e.inputRef.current)==null?void 0:m.focus({preventScroll:!0})});case S.ArrowUp:return c.preventDefault(),c.stopPropagation(),e.comboboxState===1&&(i.openCombobox(),d.nextFrame(()=>{e.value||i.goToOption(y.Last)})),d.nextFrame(()=>{var m;return(m=e.inputRef.current)==null?void 0:m.focus({preventScroll:!0})});case S.Escape:return e.comboboxState!==0?void 0:(c.preventDefault(),e.optionsRef.current&&!e.optionsPropsRef.current.static&&c.stopPropagation(),i.closeCombobox(),d.nextFrame(()=>{var m;return(m=e.inputRef.current)==null?void 0:m.focus({preventScroll:!0})}));default:return}}),u=O(c=>{if(Te(c.currentTarget))return c.preventDefault();e.comboboxState===0?i.closeCombobox():(c.preventDefault(),i.openCombobox()),d.nextFrame(()=>{var m;return(m=e.inputRef.current)==null?void 0:m.focus({preventScroll:!0})})}),C=W(()=>{if(!!e.labelRef.current)return[e.labelRef.current.id,p].join(" ")},[e.labelRef.current,p]),f=E(()=>({open:e.comboboxState===0,disabled:e.disabled}),[e]),R=a,g={ref:t,id:p,type:ce(a,e.buttonRef),tabIndex:-1,"aria-haspopup":!0,"aria-controls":(x=e.optionsRef.current)==null?void 0:x.id,"aria-expanded":e.disabled?void 0:e.comboboxState===0,"aria-labelledby":C,disabled:e.disabled,onClick:u,onKeyDown:r};return F({ourProps:g,theirProps:R,slot:f,defaultTag:Fe,name:"Combobox.Button"})}),ke="label",Ue=_(function(a,o){let e=k("Combobox.Label"),i=`headlessui-combobox-label-${B()}`,t=V(e.labelRef,o),p=O(()=>{var C;return(C=e.inputRef.current)==null?void 0:C.focus({preventScroll:!0})}),d=E(()=>({open:e.comboboxState===0,disabled:e.disabled}),[e]);return F({ourProps:{ref:t,id:i,onClick:p},theirProps:a,slot:d,defaultTag:ke,name:"Combobox.Label"})}),Be="ul",Ve=te.RenderStrategy|te.Static,je=_(function(a,o){var g;let{hold:e=!1,...i}=a,t=k("Combobox.Options"),p=V(t.optionsRef,o),d=`headlessui-combobox-options-${B()}`,r=ve(),u=(()=>r!==null?r===$.Open:t.comboboxState===0)();I(()=>{var x;t.optionsPropsRef.current.static=(x=a.static)!=null?x:!1},[t.optionsPropsRef,a.static]),I(()=>{t.optionsPropsRef.current.hold=e},[t.optionsPropsRef,e]),fe({container:t.optionsRef.current,enabled:t.comboboxState===0,accept(x){return x.getAttribute("role")==="option"?NodeFilter.FILTER_REJECT:x.hasAttribute("role")?NodeFilter.FILTER_SKIP:NodeFilter.FILTER_ACCEPT},walk(x){x.setAttribute("role","none")}});let C=W(()=>{var x,c,m;return(m=(x=t.labelRef.current)==null?void 0:x.id)!=null?m:(c=t.buttonRef.current)==null?void 0:c.id},[t.labelRef.current,t.buttonRef.current]),f=E(()=>({open:t.comboboxState===0}),[t]),R={"aria-activedescendant":t.activeOptionIndex===null||(g=t.options[t.activeOptionIndex])==null?void 0:g.id,"aria-labelledby":C,role:"listbox",id:d,ref:p};return F({ourProps:R,theirProps:i,slot:f,defaultTag:Be,features:Ve,visible:u,name:"Combobox.Options"})}),Ge="li",He=_(function(a,o){var l,j;let{disabled:e=!1,value:i,...t}=a,p=k("Combobox.Option"),d=N("Combobox.Option"),r=`headlessui-combobox-option-${B()}`,u=p.activeOptionIndex!==null?p.options[p.activeOptionIndex].id===r:!1,C=p.isSelected(i),f=A(null),R=be({disabled:e,value:i,domRef:f,textValue:(j=(l=f.current)==null?void 0:l.textContent)==null?void 0:j.toLowerCase()}),g=V(o,f),x=O(()=>d.selectOption(r));I(()=>d.registerOption(r,R),[R,r]);let c=A(!p.__demoMode);I(()=>{if(!p.__demoMode)return;let v=ee();return v.requestAnimationFrame(()=>{c.current=!0}),v.dispose},[]),I(()=>{if(p.comboboxState!==0||!u||!c.current||p.activationTrigger===0)return;let v=ee();return v.requestAnimationFrame(()=>{var P,G;(G=(P=f.current)==null?void 0:P.scrollIntoView)==null||G.call(P,{block:"nearest"})}),v.dispose},[f,u,p.comboboxState,p.activationTrigger,p.activeOptionIndex]);let m=O(v=>{var P;if(e)return v.preventDefault();x(),p.mode===0&&(d.closeCombobox(),(P=p.inputRef.current)==null||P.focus({preventScroll:!0}))}),U=O(()=>{if(e)return d.goToOption(y.Nothing);d.goToOption(y.Specific,r)}),M=O(()=>{e||u||d.goToOption(y.Specific,r,0)}),h=O(()=>{e||!u||p.optionsPropsRef.current.hold||d.goToOption(y.Nothing)}),D=E(()=>({active:u,selected:C,disabled:e}),[u,C,e]);return F({ourProps:{id:r,ref:g,role:"option",tabIndex:e===!0?void 0:-1,"aria-disabled":e===!0?!0:void 0,"aria-selected":C===!0?!0:void 0,disabled:void 0,onClick:m,onFocus:U,onPointerMove:M,onMouseMove:M,onPointerLeave:h,onMouseLeave:h},theirProps:t,slot:D,defaultTag:Ge,name:"Combobox.Option"})}),Ot=Object.assign(Le,{Input:_e,Button:we,Label:Ue,Options:je,Option:He});export{Ot as Combobox};
